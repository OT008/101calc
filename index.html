<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Okey 101 Eşli (Bireysel) Arayüz Taslağı</title>
<style>

input[type=number]::-webkit-inner-spin-button,
input[type=number]::-webkit-outer-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

input[type=number] {
  -moz-appearance: textfield;
}

body {
  font-family: "Segoe UI", sans-serif;
  background: #f3f6fb;
  color: #2c3e50;
  margin: 0;
  padding: 0;
}

.container {
  max-width: 1200px;
  margin: 30px auto;
  background: white;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
}

/* Tablo */
table {
  width: 100%;
  border-collapse: collapse;
  table-layout: fixed;
}

th, td {
  border: 1px solid #dfe6f0;
  padding: 8px;
  text-align: center;
  font-size: 14px;
}

thead th {
  background: #4a90e2;
  color: white;
  font-size: 15px;
}

/* Oyuncu isim inputları */
.oyuncu-isim {
  width: 100%;
  padding: 4px;
  border-radius: 6px;
  border: 1px solid #cfd8e3;
  text-align: center;
}

/* Her oyuncu hücresi */
.player-cell {
  vertical-align: top;
  padding: 6px;
}

/* Başlıklar */
.player-cell h4 {
  margin: 4px 0 6px;
  font-size: 13px;
  font-weight: 600;
  color: #34495e;
}

/* Kategori butonları */
.secenek {
  background: #ecf3ff;
  border-radius: 6px;
  padding: 5px 6px;
  margin: 4px 0;
  cursor: pointer;
  font-size: 13px;
  border: 1px solid #d0ddf5;
  transition: background 0.2s, border-color 0.2s, color 0.2s;
}

.secenek.aktif {
  background: #4a90e2;
  color: white;
  border-color: #4a90e2;
}

/* Kalan için input */
.kalan-input {
  width: 100%;
  padding: 4px;
  border-radius: 6px;
  border: 1px solid #cfd8e3;
  text-align: center;
  margin-bottom: 4px;
}

/* Bitti alt seçenekleri */
.bitti-ekstra {
  display: none;
  margin-top: 4px;
}

.bitti-ekstra span {
  display: inline-block;
  padding: 3px 8px;
  margin: 2px 2px;
  border-radius: 999px;
  background: #f1f5ff;
  border: 1px solid #d0ddf5;
  font-size: 12px;
  cursor: pointer;
}

.bitti-ekstra span.aktif {
  background: #2ecc71;
  color: white;
  border-color: #27ae60;
}

/* Masa butonu */
.masa-btn {
  display: inline-block;
  background: #4a90e2;
  color: white;
  padding: 4px 10px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: background 0.2s;
}
.masa-btn:hover { background: #357abd; }
.masa-btn.aktif { background: #2ecc71; }

/* Ceza satırı */
.ceza-satiri {
  margin-top: 4px;
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
  justify-content: center;
}

.ceza-satiri div {
  display: flex;
  align-items: center;
  font-size: 12px;
  background: #f7f9ff;
  border-radius: 999px;
  padding: 2px 6px;
}

.ceza-satiri button {
  margin-left: 4px;
  border: none;
  background: #e0e7ff;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  cursor: pointer;
  font-size: 14px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}
.ceza-satiri button:hover {
  background: #c7d2fe;
}

/* Genel butonlar */
.btn {
  display: inline-block;
  margin: 10px 4px 0 0;
  padding: 6px 10px;
  border-radius: 6px;
  border: none;
  background: #4a90e2;
  color: white;
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
}
.btn:hover {
  background: #357abd;
}

/* Toplam puanlar satırı */
tfoot td {
  background: #eef4ff;
  font-weight: bold;
  font-size: 15px;
  color: #2c3e50;
  border-top: 2px solid #4a90e2;
}
tfoot td:first-child {
  background: #4a90e2;
  color: white;
}

/* Yedekleme butonları */
.backup-buttons {
  display: flex;
  gap: 8px;
  margin-bottom: 10px;
  justify-content: flex-end;
  flex-wrap: wrap;
}
.backup-btn {
  background: #4a90e2;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
}
.backup-btn.export {
  background: #2ecc71;
}
.backup-btn:hover {
  opacity: 0.9;
}

</style>
</head>
<body>

<div class="container">
  <div class="backup-buttons">
    <button class="backup-btn export" id="btnExport">Yedek Al (Dosya)</button>
    <button class="backup-btn" id="btnImport">Yedek Yükle (Dosya)</button>
    <input type="file" id="backupFileInput" accept=".txt,.json" style="display:none">
  </div>
  <table>
    <!-- Oyuncu İsimleri -->
    <thead>
      <tr>
        <th>El</th>
        <th><input type="text" class="oyuncu-isim" placeholder="Oyuncu 1"></th>
        <th><input type="text" class="oyuncu-isim" placeholder="Oyuncu 2"></th>
        <th><input type="text" class="oyuncu-isim" placeholder="Oyuncu 3"></th>
        <th><input type="text" class="oyuncu-isim" placeholder="Oyuncu 4"></th>
      </tr>
    </thead>

    <!-- 1. El -->
    <tbody>
      <tr>
        <td><b>1</b></td>

        <!-- Oyuncu 1 -->
        <td class="player-cell">
          <div class="kategori">
            <h4>Açma Durumu</h4>
            <div class="secenek">Açamadı</div>
            <div class="secenek kalan">Kalan</div>
            <div class="secenek">Bitti</div>
          </div>

          <div class="bitti-ekstra">
            <h4>Ekstra</h4>
            <span class="okey">Okey</span>
            <span class="elden">Elden</span>
          </div>

          <div class="masa-satiri">
            <span class="masa-btn">Masa</span>
          </div>

          <div class="ceza-satiri">
            <div>+5:
              <button class="ceza-eksi">-</button>
              <span>0</span>
              <button class="ceza-arti">+</button>
            </div>
            <div>+10:
              <button class="ceza-eksi">-</button>
              <span>0</span>
              <button class="ceza-arti">+</button>
            </div>
            <div>+20:
              <button class="ceza-eksi">-</button>
              <span>0</span>
              <button class="ceza-arti">+</button>
            </div>
          </div>
        </td>

        <!-- Oyuncu 2 -->
        <td class="player-cell">
          <div class="kategori">
            <h4>Açma Durumu</h4>
            <div class="secenek">Açamadı</div>
            <div class="secenek kalan">Kalan</div>
            <div class="secenek">Bitti</div>
          </div>

          <div class="bitti-ekstra">
            <h4>Ekstra</h4>
            <span class="okey">Okey</span>
            <span class="elden">Elden</span>
          </div>

          <div class="masa-satiri">
            <span class="masa-btn">Masa</span>
          </div>

          <div class="ceza-satiri">
            <div>+5:
              <button class="ceza-eksi">-</button>
              <span>0</span>
              <button class="ceza-arti">+</button>
            </div>
            <div>+10:
              <button class="ceza-eksi">-</button>
              <span>0</span>
              <button class="ceza-arti">+</button>
            </div>
            <div>+20:
              <button class="ceza-eksi">-</button>
              <span>0</span>
              <button class="ceza-arti">+</button>
            </div>
          </div>
        </td>

        <!-- Oyuncu 3 -->
        <td class="player-cell">
          <div class="kategori">
            <h4>Açma Durumu</h4>
            <div class="secenek">Açamadı</div>
            <div class="secenek kalan">Kalan</div>
            <div class="secenek">Bitti</div>
          </div>

          <div class="bitti-ekstra">
            <h4>Ekstra</h4>
            <span class="okey">Okey</span>
            <span class="elden">Elden</span>
          </div>

          <div class="masa-satiri">
            <span class="masa-btn">Masa</span>
          </div>

          <div class="ceza-satiri">
            <div>+5:
              <button class="ceza-eksi">-</button>
              <span>0</span>
              <button class="ceza-arti">+</button>
            </div>
            <div>+10:
              <button class="ceza-eksi">-</button>
              <span>0</span>
              <button class="ceza-arti">+</button>
            </div>
            <div>+20:
              <button class="ceza-eksi">-</button>
              <span>0</span>
              <button class="ceza-arti">+</button>
            </div>
          </div>
        </td>

        <!-- Oyuncu 4 -->
        <td class="player-cell">
          <div class="kategori">
            <h4>Açma Durumu</h4>
            <div class="secenek">Açamadı</div>
            <div class="secenek kalan">Kalan</div>
            <div class="secenek">Bitti</div>
          </div>

          <div class="bitti-ekstra">
            <h4>Ekstra</h4>
            <span class="okey">Okey</span>
            <span class="elden">Elden</span>
          </div>

          <div class="masa-satiri">
            <span class="masa-btn">Masa</span>
          </div>

          <div class="ceza-satiri">
            <div>+5:
              <button class="ceza-eksi">-</button>
              <span>0</span>
              <button class="ceza-arti">+</button>
            </div>
            <div>+10:
              <button class="ceza-eksi">-</button>
              <span>0</span>
              <button class="ceza-arti">+</button>
            </div>
            <div>+20:
              <button class="ceza-eksi">-</button>
              <span>0</span>
              <button class="ceza-arti">+</button>
            </div>
          </div>
        </td>
      </tr>
    </tbody>

    <!-- Toplam Puanlar Satırı -->
    <tfoot>
      <tr>
        <td>TOPLAM</td>
        <td id="toplam1">0</td>
        <td id="toplam2">0</td>
        <td id="toplam3">0</td>
        <td id="toplam4">0</td>
      </tr>
    </tfoot>
  </table>

  <button class="btn" id="btnYeniEl">Yeni El Ekle</button>
  <button class="btn" id="btnSilEl">Son Eli Sil</button>
  <button class="btn" id="btnYeniOyun">Yeni Oyun</button>
</div>

<script>
/* --- Yardımcı: En yakın satırı bulma --- */
function enYakinTR(eleman) {
  while (eleman && eleman.tagName !== 'TR') {
    eleman = eleman.parentElement;
  }
  return eleman;
}

/* --- El satırı oluşturma --- */
function yeniElSatiri(eldekiIndex) {
  const tr = document.createElement('tr');

  const elNoTd = document.createElement('td');
  elNoTd.innerHTML = '<b>' + eldekiIndex + '</b>';
  tr.appendChild(elNoTd);

  for (let i = 0; i < 4; i++) {
    const td = document.createElement('td');
    td.className = 'player-cell';
    td.innerHTML = `
      <div class="kategori">
        <h4>Açma Durumu</h4>
        <div class="secenek">Açamadı</div>
        <div class="secenek kalan">Kalan</div>
        <div class="secenek">Bitti</div>
      </div>

      <div class="bitti-ekstra">
        <h4>Ekstra</h4>
        <span class="okey">Okey</span>
        <span class="elden">Elden</span>
      </div>

      <div class="masa-satiri">
        <span class="masa-btn">Masa</span>
      </div>

      <div class="ceza-satiri">
        <div>+5:
          <button class="ceza-eksi">-</button>
          <span>0</span>
          <button class="ceza-arti">+</button>
        </div>
        <div>+10:
          <button class="ceza-eksi">-</button>
          <span>0</span>
          <button class="ceza-arti">+</button>
        </div>
        <div>+20:
          <button class="ceza-eksi">-</button>
          <span>0</span>
          <button class="ceza-arti">+</button>
        </div>
      </div>
    `;
    tr.appendChild(td);
  }

  return tr;
}

/* --- Yeni el ekle --- */
function yeniElEkle() {
  const tbody = document.querySelector('tbody');
  const mevcutSatirlar = tbody.querySelectorAll('tr').length;
  const yeniIndex = mevcutSatirlar + 1;
  const tr = yeniElSatiri(yeniIndex);
  tbody.appendChild(tr);
}

/* --- Son eli sil --- */
function sonElSil() {
  const tbody = document.querySelector('tbody');
  const satirlar = tbody.querySelectorAll('tr');
  if (satirlar.length > 1) {
    tbody.removeChild(satirlar[satirlar.length - 1]);
  }
}

/* --- Sabitler ve state fonksiyonları --- */
const LS_KEY = 'okey101_state_v2';

function stateTopla() {
  const state = {
    oyuncuIsimleri: Array.from(document.querySelectorAll('thead .oyuncu-isim'))
      .map(inp => inp.value || ''),
    eller: [],
  };

  const tbodyRows = document.querySelectorAll('tbody tr');

  tbodyRows.forEach((tr) => {
    const el = [];
    let elBosMu = true;

    tr.querySelectorAll('.player-cell').forEach((cell) => {
      const acmaKat = cell.querySelector('.kategori'); // ilk kategori
      const acmadi = acmaKat?.querySelector('[data-role="acmadi"]')?.classList.contains('aktif') || false;

      const kalanInput = cell.querySelector('.kalan-input');
      const kalanDeger = kalanInput && kalanInput.value ? parseInt(kalanInput.value, 10) : null;

      const bittiBtnAktif = acmaKat?.querySelector('[data-role="bitti"]')?.classList.contains('aktif') || false;
      const okeyBtnAktif = cell.querySelector('.bitti-ekstra .okey')?.classList.contains('aktif') || false;
      const eldenBtnAktif = cell.querySelector('.bitti-ekstra .elden')?.classList.contains('aktif') || false;

      const masa = cell.querySelector('.masa-btn')?.classList.contains('aktif') || false;

      const cezalar = Array.from(cell.querySelectorAll('.ceza-satiri span'))
        .map(sp => parseInt(sp.textContent || '0', 10) || 0);

      if (
        acmadi ||
        kalanDeger ||
        bittiBtnAktif ||
        okeyBtnAktif ||
        eldenBtnAktif ||
        masa ||
        cezalar.some(c => c !== 0)
      ) {
        elBosMu = false;
      }

      el.push({
        acmadi,
        kalanDeger,
        bittiBtn: bittiBtnAktif,
        okey: okeyBtnAktif,
        elden: eldenBtnAktif,
        masa,
        cezalar
      });
    });

    if (!elBosMu) {
      state.eller.push(el);
    }
  });

  const pasifEller = [];
  tbodyRows.forEach((tr, idx) => {
    const ilkEl = tr.querySelector('.player-cell .secenek');
    if (ilkEl && getComputedStyle(ilkEl).pointerEvents === 'none') {
      pasifEller.push(idx);
    }
  });
  state.pasifEller = pasifEller;

  return state;
}

function stateUygula(state) {
  if (!state || !state.eller?.length) return;

  // Oyuncu isimleri
  const isimInputlari = document.querySelectorAll('thead .oyuncu-isim');
  state.oyuncuIsimleri?.forEach((ad, i) => { if (isimInputlari[i]) isimInputlari[i].value = ad; });

  // El sayısını eşitle (gerekenden azsa yeniElEkle ile çoğalt)
  const tbody = document.querySelector('tbody');
  let mevcut = tbody.querySelectorAll('tr').length;
  while (mevcut < state.eller.length) {
    yeniElEkle();
    mevcut++;
  }

  // Her şeyi sıfırla
  tbody.querySelectorAll('tr').forEach((tr) => {
    tr.querySelectorAll('.secenek').forEach(s => s.classList.remove('aktif'));
    tr.querySelectorAll('.bitti-ekstra span').forEach(s => s.classList.remove('aktif'));
    tr.querySelectorAll('.kalan-input').forEach(i => i.remove());
    tr.querySelectorAll('.bitti-ekstra').forEach(e => e.style.display = 'none');
    tr.querySelectorAll('.masa-btn').forEach(b => { b.classList.remove('aktif'); b.style.display = 'inline-block'; });
    tr.querySelectorAll('.ceza-satiri span').forEach(sp => sp.textContent = '0');
    tr.querySelectorAll('.player-cell .kategori').forEach(k => { k.style.display = 'block'; });
  });

  // Hücre hücre uygula
  const satirlar = tbody.querySelectorAll('tr');
  state.eller.forEach((el, rowIdx) => {
    const tr = satirlar[rowIdx];
    if (!tr) return;
    const cells = tr.querySelectorAll('.player-cell');

    el.forEach((h, colIdx) => {
      const cell = cells[colIdx];
      if (!cell) return;
      const acmaKat = cell.querySelector('.kategori');
      const bittiEkstra = cell.querySelector('.bitti-ekstra');
      const secenekler = acmaKat ? acmaKat.querySelectorAll('.secenek') : [];

      // Açma durumu
      if (h.acmadi && secenekler[0]) {
        secenekler[0].classList.add('aktif');
      } else if (h.kalanDeger && secenekler[1]) {
        secenekler[1].classList.add('aktif');
      } else if (h.bittiBtn && secenekler[2]) {
        secenekler[2].classList.add('aktif');
      }

      // Bitti altları
      if (h.bittiBtn && bittiEkstra) {
        bittiEkstra.style.display = 'block';
        const okeySpan = bittiEkstra.querySelector('.okey');
        const eldenSpan = bittiEkstra.querySelector('.elden');
        if (h.okey && okeySpan) okeySpan.classList.add('aktif');
        if (h.elden && eldenSpan) eldenSpan.classList.add('aktif');
      }

      // Masa
      const masaBtn = cell.querySelector('.masa-btn');
      if (masaBtn && h.masa) masaBtn.classList.add('aktif');

      // Kalan
      if (h.kalanDeger) {
        // Butonu inputa çevir
        const kalBtn = cell.querySelector('.secenek.kalan');
        if (kalBtn) {
          const input = document.createElement('input');
          input.type = 'number';
          input.className = 'kalan-input';
          input.min = '1'; input.max = '252';
          input.value = h.kalanDeger;
          kalBtn.replaceWith(input);
        }
      }

      // Cezalar
      const cezaSpans = cell.querySelectorAll('.ceza-satiri div span');
      h.cezalar?.forEach((val, i) => {
        if (cezaSpans[i]) cezaSpans[i].textContent = val;
      });
    });
  });

  // Pasif eller
  if (Array.isArray(state.pasifEller)) {
    const tbody2 = document.querySelector('tbody');
    const satirlar2 = tbody2.querySelectorAll('tr');
    state.pasifEller.forEach((idx) => {
      const tr = satirlar2[idx];
      if (!tr) return;
      tr.querySelectorAll('.player-cell .secenek').forEach((secenek) => {
        secenek.style.pointerEvents = 'none';
        secenek.style.opacity = '0.6';
      });
    });
  }

  puanlariHesapla();
}

function stateKaydet() {
  try {
    const s = stateTopla();
    localStorage.setItem(LS_KEY, JSON.stringify(s));
  } catch (e) {
    console.warn('Kaydetme hatası:', e);
  }
}

function stateYukle() {
  try {
    const raw = localStorage.getItem(LS_KEY);
    if (!raw) return;
    const s = JSON.parse(raw);
    stateUygula(s);
  } catch (e) {
    console.warn('Yükleme hatası:', e);
  }
}

function yeniOyunSifirla() {
  localStorage.removeItem(LS_KEY);
  location.reload(); // en güvenlisi: sayfayı ilk haline al
}

// ==== DOSYA TABANLI YEDEKLEME (GitHub Pages + her yerde çalışır) ====

function yedekDosyaIcindekiVeri() {
  const state = stateTopla();          // mevcut durumu topla
  const encoded = btoa(JSON.stringify(state)); // base64
  return encoded;
}

function yedekIndir() {
  try {
    const data = yedekDosyaIcindekiVeri();
    const blob = new Blob([data], { type: "text/plain" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "okey101_yedek_" + new Date().toISOString().slice(0, 10) + ".txt";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  } catch (e) {
    console.error("Yedek indirme hatası:", e);
    alert("Yedek alınırken bir hata oluştu.");
  }
}

function yedekDosyadanYukle(icerik) {
  try {
    const decoded = JSON.parse(atob(icerik.trim()));
    stateUygula(decoded);
    alert("Yedek başarıyla yüklendi.");
  } catch (e) {
    console.error(e);
    alert("Yedek okunamadı / bozuk: " + e.message);
  }
}

window.addEventListener("load", () => {
  const btnExport = document.getElementById("btnExport");
  const btnImport = document.getElementById("btnImport");
  const fileInput = document.getElementById("backupFileInput");

  if (btnExport) {
    btnExport.addEventListener("click", yedekIndir);
  }

  if (btnImport && fileInput) {
    btnImport.addEventListener("click", () => fileInput.click());

    fileInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = () => {
        const content = reader.result || "";
        yedekDosyadanYukle(content);
      };
      reader.readAsText(file);
    });
  }
});

// --- Olaylara bağla: her tıklama ve input sonrası kaydet
document.addEventListener('click', (e) => {
  const hedef = e.target;

  if (hedef.classList.contains('secenek')) {
    const tr = enYakinTR(hedef);
    // Aynı satır ve aynı oyuncu içinde sadece biri aktif olsun
    const parentKategori = hedef.closest('.kategori');
    if (parentKategori) {
      parentKategori.querySelectorAll('.secenek').forEach(s => s.classList.remove('aktif'));
    }
    hedef.classList.add('aktif');

    // Kalan'a tıklanırsa input'a çevir
    if (hedef.classList.contains('kalan')) {
      const cell = hedef.closest('.player-cell');
      const input = document.createElement('input');
      input.type = 'number';
      input.className = 'kalan-input';
      input.min = '1';
      input.max = '252';
      input.placeholder = 'Kalan';
      hedef.replaceWith(input);
      input.focus();
    }

    // Bitti'ye tıklanırsa ekstra seçenekleri göster
    if (hedef.textContent.trim() === 'Bitti') {
      const cell = hedef.closest('.player-cell');
      if (cell) {
        const ekstra = cell.querySelector('.bitti-ekstra');
        if (ekstra) ekstra.style.display = 'block';
        const masaBtn = cell.querySelector('.masa-btn');
        if (masaBtn) masaBtn.style.display = 'none';
      }
    }

    // Açamadı'ya tıklanırsa kalan inputunu kaldır, ekstra kapat
    if (hedef.textContent.trim() === 'Açamadı') {
      const cell = hedef.closest('.player-cell');
      if (cell) {
        const kalanInput = cell.querySelector('.kalan-input');
        if (kalanInput) {
          const yeniButon = document.createElement('div');
          yeniButon.className = 'secenek kalan';
          yeniButon.textContent = 'Kalan';
          kalanInput.replaceWith(yeniButon);
        }
        const ekstra = cell.querySelector('.bitti-ekstra');
        if (ekstra) ekstra.style.display = 'none';

        const masaBtn = cell.querySelector('.masa-btn');
        if (masaBtn) {
          masaBtn.style.display = 'inline-block';
          masaBtn.classList.remove('aktif');
        }
      }
    }

    puanlariHesapla();
    stateKaydet();
  }

  // Bitti ekstra (Okey/Elden) tıklamaları
  if (hedef.closest('.bitti-ekstra span')) {
    hedef.classList.toggle('aktif');
    puanlariHesapla();
    stateKaydet();
  }

  // Masa butonu
  if (hedef.classList.contains('masa-btn')) {
    hedef.classList.toggle('aktif');
    puanlariHesapla();
    stateKaydet();
  }

  // Ceza +/- butonları
  if (hedef.classList.contains('ceza-arti') || hedef.classList.contains('ceza-eksi')) {
    const span = hedef.parentElement.querySelector('span');
    let deger = parseInt(span.textContent || '0', 10);
    if (hedef.classList.contains('ceza-arti')) {
      deger++;
    } else {
      deger = Math.max(0, deger - 1);
    }
    span.textContent = deger;
    puanlariHesapla();
    stateKaydet();
  }

  // Yeni El butonu
  if (hedef.id === 'btnYeniEl') {
    yeniElEkle();
    stateKaydet();
  }

  // Son El Sil butonu
  if (hedef.id === 'btnSilEl') {
    sonElSil();
    puanlariHesapla();
    stateKaydet();
  }

  // Yeni Oyun butonu
  if (hedef.id === 'btnYeniOyun') {
    if (confirm('Tüm oyunu sıfırlamak istediğine emin misin?')) {
      yeniOyunSifirla();
    }
  }
});

// Input değişince (kalan inputu veya isimler)
document.addEventListener('input', (e) => {
  const hedef = e.target;
  if (hedef.classList.contains('kalan-input') || hedef.classList.contains('oyuncu-isim')) {
    puanlariHesapla();
    stateKaydet();
  }
});

/* --- Puan Hesaplama --- */
function puanlariHesapla() {
  const tbody = document.querySelector('tbody');
  const satirlar = tbody.querySelectorAll('tr');

  let toplamPuan = [0, 0, 0, 0]; // Oyuncu 1-4

  satirlar.forEach((tr, elIndex) => {
    const hucreler = tr.querySelectorAll('.player-cell');
    hucreler.forEach((cell, oyuncuIndex) => {
      let puan = 0;

      const acmaKat = cell.querySelector('.kategori');
      const acmadi = acmaKat?.querySelector('.secenek:nth-child(2)')?.classList.contains('aktif');
      const kalanBtn = cell.querySelector('.kalan-input');
      const bittiAktif = acmaKat?.querySelector('.secenek:nth-child(4)')?.classList.contains('aktif');

      const okeyAktif = cell.querySelector('.bitti-ekstra .okey')?.classList.contains('aktif');
      const eldenAktif = cell.querySelector('.bitti-ekstra .elden')?.classList.contains('aktif');

      const masaAktif = cell.querySelector('.masa-btn')?.classList.contains('aktif');

      if (acmadi) {
        puan += 20;
      }

      if (kalanBtn && kalanBtn.value) {
        puan += parseInt(kalanBtn.value, 10) || 0;
      }

      if (bittiAktif) {
        puan -= 100;
        if (okeyAktif) puan -= 50;
        if (eldenAktif) puan -= 20;
      }

      if (masaAktif) {
        puan += 20;
      }

      const cezaSpans = cell.querySelectorAll('.ceza-satiri div span');
      const cezaDegerler = Array.from(cezaSpans).map(sp => parseInt(sp.textContent || '0', 10));
      const cezaCarpanlar = [5, 10, 20];

      cezaDegerler.forEach((adet, idx) => {
        puan += adet * cezaCarpanlar[idx];
      });

      toplamPuan[oyuncuIndex] += puan;
    });
  });

  document.getElementById('toplam1').textContent = toplamPuan[0];
  document.getElementById('toplam2').textContent = toplamPuan[1];
  document.getElementById('toplam3').textContent = toplamPuan[2];
  document.getElementById('toplam4').textContent = toplamPuan[3];
}

/* --- Sayfa yüklenince localStorage'dan yükle --- */
window.addEventListener('load', () => {
  stateYukle();
  puanlariHesapla();
});
</script>
</body>
</html>
